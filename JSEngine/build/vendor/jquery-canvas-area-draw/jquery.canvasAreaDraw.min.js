!function(t){t.fn.canvasAreaDraw=function(t){this.each((function(n,o){e.apply(o,[n,o,t])}))};var e=function(e,o,f){var a,r,i,s,u,h,l,c,g,p,v,d,m,M,w;i=f,l=t('<input type="hidden">'),i.coordinates&&l.val(i.coordinates),a=l.val().length?l.val().split(",").map((function(t){return parseInt(t,10)})):[],s=t("<canvas>"),u=s[0].getContext("2d"),h=new Image,d=function(){s.attr("height",h.height).attr("width",h.width),c()},t(h).on("load",d),h.src=i.imageUrl,h.loaded&&d(),s.css({background:"url("+h.src+")"}),t(this).append(l,s),m=function(){a=[],c()},v=function(e){e.offsetX||(e.offsetX=e.pageX-t(e.target).offset().left,e.offsetY=e.pageY-t(e.target).offset().top),a[r]=Math.round(e.offsetX),a[r+1]=Math.round(e.offsetY),c()},p=function(){t(this).off("mousemove"),w(),r=null},M=function(e){e.preventDefault(),e.offsetX||(e.offsetX=e.pageX-t(e.target).offset().left,e.offsetY=e.pageY-t(e.target).offset().top);for(var n=e.offsetX,o=e.offsetY,f=0;f<a.length;f+=2)if(dis=Math.sqrt(Math.pow(n-a[f],2)+Math.pow(o-a[f+1],2)),dis<6)return a.splice(f,2),c(),w(),!1;return!1},g=function(e){var o,f,i=a.length;if(3===e.which)return!1;e.preventDefault(),e.offsetX||(e.offsetX=e.pageX-t(e.target).offset().left,e.offsetY=e.pageY-t(e.target).offset().top),o=e.offsetX,f=e.offsetY;for(var s=0;s<a.length;s+=2)if(Math.sqrt(Math.pow(o-a[s],2)+Math.pow(f-a[s+1],2))<6)return r=s,t(this).on("mousemove",v),!1;for(s=0;s<a.length;s+=2)s>1&&n(o,f,a[s],a[s+1],a[s-2],a[s-1],!0)<6&&(i=s);return a.splice(i,0,Math.round(o),Math.round(f)),r=i,t(this).on("mousemove",v),c(),w(),!1},c=function(){if(u.canvas.width=u.canvas.width,w(),a.length<2)return!1;u.globalCompositeOperation="destination-over",u.fillStyle="rgb(255,255,255)",u.strokeStyle="rgb(255,20,20)",u.lineWidth=1,u.beginPath(),u.moveTo(a[0],a[1]);for(var t=0;t<a.length;t+=2)u.fillRect(a[t]-2,a[t+1]-2,4,4),u.strokeRect(a[t]-2,a[t+1]-2,4,4),a.length>2&&t>1&&u.lineTo(a[t],a[t+1]);u.closePath(),u.fillStyle="rgba(255,0,0,0.3)",u.fill(),u.stroke()},w=function(){l.val(a.join(","))},t(this).on("reset",m),s.on("mousedown",g),s.on("contextmenu",M),s.on("mouseup",p)},n=function(t,e,n,o,f,a,r){function i(t,e,n,o){return Math.sqrt((t-=n)*t+(e-=o)*e)}if(!r||(r=function(t,e,n,o,f,a){if(!(f-n))return{x:n,y:e};if(!(a-o))return{x:t,y:o};var r,i=-1/((a-o)/(f-n));return{x:r=(f*(t*i-e+o)+n*(t*-i+e-a))/(i*(f-n)+o-a),y:i*r-i*t+e}}(t,e,n,o,f,a)).x>=Math.min(n,f)&&r.x<=Math.max(n,f)&&r.y>=Math.min(o,a)&&r.y<=Math.max(o,a)){var s=o-a,u=f-n,h=n*a-o*f;return Math.abs(s*t+u*e+h)/Math.sqrt(s*s+u*u)}var l=i(t,e,n,o),c=i(t,e,f,a);return l>c?c:l}}(jQuery);