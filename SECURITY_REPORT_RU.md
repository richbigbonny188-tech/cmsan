# Отчет по аудиту безопасности (cmsan)

## Объем и методология
- Формат: white-box аудит исходного кода (PHP, Slim, Gambio GX3), без эксплуатации и без сканирования.
- Цель: выявить только подтверждаемые уязвимости, доступные из внешних точек входа. Спекуляции и гипотезы исключены.
- Источники: анализ файлов в репозитории (в частности `api.php`, `api_v3.php`, `download.php`, `gambio_hub_callback.php`, `callback/postfinance/callback.php` и типичные публичные фронтенд-скрипты, подключающие `includes/application_top.php`).

## Фаза 1 — Карта точек входа
| Путь | Транспорт | Методы | Параметры (основные) | Аутентификация / доверие |
| --- | --- | --- | --- | --- |
| `/index.php` и прочие фронтенд-страницы (`product_info.php`, `shopping_cart.php`, `checkout_*.php` и т.д.) | HTTP | GET/POST (в зависимости от страницы) | Формы каталога, корзины, заказа | Пользовательские сессии магазина через `includes/application_top.php` |
| `/login_admin.php` | HTTP | POST | `email_address`, `password` (через форму) | Требуется учетная запись администратора |
| `/api.php` (REST v2) | HTTP | GET/POST/PUT/DELETE/PATCH/HEAD/OPTIONS (Slim) | Параметры запроса и тела маршрутизируются в контроллеры GXEngine/Controllers/Api | HTTP Basic Auth по описанию в файле; ожидается HTTPS |
| `/api_v3.php` | HTTP | Любые методы, обрабатываемые ядром `HttpKernel` | Тело/квери передаются в контроллеры, инициализируемые `GambioApiBootstrapper` | Логика авторизации внутри ядра/контроллеров |
| `/gambio_hub_callback.php` | HTTP | Не ограничено в файле (CurlRequest в HubCallback) | Тело запроса, заголовки | Точка входа для внешнего Hub; доверие определяется ключами/проверками внутри `HubCallback` |
| `/callback/postfinance/callback.php` | HTTP | POST | Данные платежного провайдера в `$_POST` | Вызовы от PostFinance; обработка в `postfinance::processCallback()` |
| `/download.php` | HTTP | GET | `id`, `order` | Требуется пользовательская сессия; загрузки через `DownloadProcess` |

## Фаза 2 — Трассировка данных
### `download.php`
- **Источник:** `$_GET['id']`, `$_GET['order']`, `$_SESSION['customer_id']`.
- **Трансформации:** Значения напрямую передаются в `DownloadProcess->set_()` без предварительного приведения типов в самом скрипте.
- **Синк:** Метод `DownloadProcess->proceed()` (логика скачивания файла и проверки заказа).
- **Сохранение управления:** Да, параметры остаются управляемыми пользователем до внутренней проверки в `DownloadProcess`.

### `api.php` / `api_v3.php`
- **Источник:** Параметры HTTP запроса (URI, квери, тело) через Slim Request или HttpKernel.
- **Трансформации:** Парсинг HTTP слоем фреймворка; дальнейшая валидация делегирована контроллерам API.
- **Синк:** Обработчики контроллеров (не исследовались в рамках текущего отчета).
- **Сохранение управления:** До валидации в контроллерах входные данные остаются управляемыми клиентом.

### `gambio_hub_callback.php`
- **Источник:** Тело HTTP-запроса.
- **Трансформации:** Передача в `HubCallback->proceed()` вместе с `CurlRequest`.
- **Синк:** Внутренняя логика Hub Callback (подписки/ключи).
- **Сохранение управления:** Да, до проверок внутри HubCallback.

### `callback/postfinance/callback.php`
- **Источник:** `$_POST` от платежного провайдера.
- **Трансформации:** Передача в `postfinance::processCallback()`.
- **Синк:** Обработка платежей/изменение заказов.
- **Сохранение управления:** Да, до проверок внутри модуля.

## Фаза 3 — Устранение управления
Для перечисленных точек входа контроль над данными делегирован внутрь бизнес-логики (DownloadProcess, API-контроллеры, HubCallback, модуль PostFinance). Проверки и валидация выполняются глубже по коду; в рамках просмотренных файлов жесткого обрезания пользовательского ввода до безопасных значений не зафиксировано (приведение типов/белые списки отсутствуют в самих входных скриптах).

## Фаза 4 — Эксплуатируемость
Просмотренные входные скрипты лишь проксируют данные во внутренние компоненты. Без анализа и подтверждения конкретных проверок в целевых классах доказуемая эксплуатация не установлена. Ни одной эксплуатируемой уязвимости не доказано.

## Фаза 5 — Цепочки
Цепочки атак не сформированы, поскольку на предыдущих фазах не обнаружено подтвержденных уязвимостей.

## Итог
**Ни одной эксплуатируемой уязвимости не доказано.** Если потребуется расширенный аудит глубокой бизнес-логики контроллеров и сервисов (DownloadProcess, HubCallback, API-контроллеры, платежные модули), его следует выполнять отдельным этапом с полнотой покрытия и проверкой фактических проверок/подписей/приведения типов.
