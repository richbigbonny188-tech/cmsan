"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};gambio.widgets.module("cart_handler",["hooks","form","xhr","loading_spinner",gambio.source+"/libs/events",gambio.source+"/libs/modal.ext-magnific",gambio.source+"/libs/modal"],(function(e){var t=$(this),a=$("body"),i=$(window),r=!1,o=null,s=0,n={},c=$.extend(!0,{},{addCartUrl:"shop.php?do=Cart/BuyProduct",addCartCustomizerUrl:"shop.php?do=Cart/Add",checkUrl:"shop.php?do=CheckStatus",wishlistUrl:"shop.php?do=WishList/Add",priceOfferUrl:"gm_price_offer.php",priceOfferMethod:"get",dropdown:"#head_shopping_cart",cartButtons:".js-btn-add-to-cart",wishlistButtons:".btn-wishlist",priceOfferButtons:".btn-price-offer",attributes:".js-calculate",productOptions:".modifier-group .modifier-content .modifier-item",productOptionField:".hidden-input",quantity:".js-calculate-qty",tpl:null,attributImagesSwiper:!1,triggerAttrImagesTo:"#product_image_swiper, #product_thumbnail_swiper, #product_thumbnail_swiper_mobile",processingClass:"loading",processingDuration:2e3,selectorMapping:{buttons:".shopping-cart-button",giftContent:".gift-cart-content-wrapper",giftLayer:".gift-cart-layer",shareContent:".share-cart-content-wrapper",shareLayer:".share-cart-layer",hiddenOptions:"#cart_quantity .hidden-options",message:".global-error-messages",messageCart:".cart-error-msg",messageHelp:".help-block",modelNumber:".model-number",modelNumberText:".model-number-text",price:".current-price-container",modifiersForm:".modifiers-selection",quantity:".products-quantity-value",quantityInfo:".products-quantity",ribbonSpecial:".ribbon-special",shippingInformation:"#shipping-information-layer",shippingTime:".products-shipping-time-value",shippingTimeImage:".img-shipping-time img",totals:"#cart_quantity .total-box",weight:".products-details-weight-container span",abroadShippingInfo:".abroad-shipping-info"},page:"product-listing"},e),l={},d=($(window).width(),function(e,t){var a=setTimeout((function(){e.removeClass(c.processingClass+" "+c.processingClass+t)}),c.processingDuration);e.data("timer",a).addClass(c.processingClass+t)}),u=function(e,r,o,s){if(c.attributImagesSwiper&&e.attrImages&&e.attrImages.length&&(delete e.content.images,$(c.triggerAttrImagesTo).trigger(jse.libs.theme.events.SLIDES_UPDATE(),{attributes:e.attrImages})),$.each(e.content,(function(e,i){var o=a.hasClass("page-product-info")?t.find(c.selectorMapping[i.selector]):r.parent().find(c.selectorMapping[i.selector]);if((!s||""===i.value)&&"messageNoCombiSelected"===e)return!0;switch(i.type){case"hide":"true"===i.value?o.hide():o.show();break;case"html":o.html(i.value);break;case"attribute":o.attr(i.key,i.value);break;case"replace":i.value?o.replaceWith(i.value):o.addClass("hidden").empty();break;default:o.text(i.value)}})),o){var n=r.find(c.cartButtons);e.success?(n.removeClass("inactive"),n.removeClass("btn-inactive"),n.prop("disabled",!1)):(n.addClass("inactive"),n.addClass("btn-inactive"),n.prop("disabled",!0))}if(e.content.message){var l=r.find(c.selectorMapping[e.content.message.selector]);e.content.message.value?l.removeClass("hidden").show():(l.addClass("hidden").hide(),s&&void 0!==e.content.messageNoCombiSelected&&e.content.messageNoCombiSelected&&(e.content.messageNoCombiSelected.value?l.removeClass("hidden").show():l.addClass("hidden").hide()))}i.trigger(jse.libs.theme.events.STICKYBOX_CONTENT_CHANGE())},p=function(e,t,i,o){function s(){jse.libs.xhr.post({url:i,data:e},!0).done((function(e){try{if(u(e,t,!1),e.success)switch(e.type){case"url":"http"!==e.url.substr(0,4)?location.href=jse.core.config.get("appUrl")+"/"+e.url:location.href=e.url;break;case"dropdown":a.trigger(jse.libs.theme.events.CART_UPDATE(),[!0]);break;case"layer":jse.libs.theme.modal.info({title:e.title,content:e.msg})}}catch(e){}d(o,"-success")})).fail((function(){d(o,"-fail")})).always((function(){r=!1}))}r||(r=!0,jse.libs.hooks.execute(jse.libs.hooks.keys.shop.cart.add,e,500).then(s).catch(s))},f=function(e){e&&e.preventDefault();var r=$(this),s=r.is("form")?r:r.closest("form"),l=s.hasClass("customizer"),f=!!s.find(".properties-selection-form").length,m=f?"":"/Attributes",h=e&&e.data&&e.data.target&&"check"!==e.data.target;if(s.length){if(f&&t.addClass("loading"),r.is("select")){var g=r.find(":selected").attr("data-price");r.parents(".modifier-group").find(".selected-value-price").text(g)}var b=$("#current-gallery-hash").val();s.find("#update-gallery-hash").val(b);var v=jse.libs.form.getData(s,null,!0);if(v.target=e&&e.data&&e.data.target?e.data.target:"check",v.isProductInfo=s.hasClass("product-info")?1:0,o&&e&&o.abort(),"check"!==v.target){var C=r.data("timer");C&&clearTimeout(C),r.removeClass(c.processingClass+"-success "+c.processingClass+"-fail").addClass(c.processingClass)}v.previousModifiers=n,o=jse.libs.xhr.get({url:c.checkUrl+m,data:v},!0).done((function(e){if(u(e,s,!0,h),t.removeClass("loading"),"check"===v.target&&""!==e.content.imageGallery.trim()&&!0===e.content.replaceGallery&&1===v.isProductInfo){var o=jse.libs.loading_spinner.show($(".product-info-stage"),9999),f=[$("#product_image_swiper"),$("#product_thumbnail_swiper"),$("#product_thumbnail_swiper_mobile")],m=!0,g=!1,b=void 0;try{for(var C,y=f[Symbol.iterator]();!(m=(C=y.next()).done);m=!0){var _=C.value,w=_.swiper();"object"===(void 0===w?"undefined":_typeof(w))&&(w.destroy(!0,!0),_.off().remove())}}catch(e){g=!0,b=e}finally{try{!m&&y.return&&y.return()}finally{if(g)throw b}}$("#image-collection-container").html(e.content.imageGallery),$("#product_image_layer").html(e.content.imageModal),gambio.widgets.init($(".product-info-content")).done((function(){jse.libs.loading_spinner.hide(o)}))}else"check"===v.target&&""===e.content.imageGallery.trim()&&!0===e.content.replaceGallery&&($("#image-collection-container").html(e.content.imageGallery),$("#product_image_layer").html(e.content.imageModal));if(e.success){var k=null,T=null;switch(v.target){case"wishlist":l&&(k=jse.libs.theme.events.ADD_CUSTOMIZER_WISHLIST()),T=c.wishlistUrl;break;case"cart":l?(k=jse.libs.theme.events.ADD_CUSTOMIZER_CART(),T=c.addCartCustomizerUrl):T=c.addCartUrl;break;case"price_offer":return s.attr("action",c.priceOfferUrl).attr("method",c.priceOfferMethod),s.off("submit"),void s.submit();default:setTimeout((function(){i.trigger(jse.libs.theme.events.STICKYBOX_CONTENT_CHANGE())}),250)}if(k){var S=$.Deferred();S.done((function(e){v[e]=0,p(v,s,T,r)})).fail((function(){d(r,"-fail")})),a.trigger(k,[{deferred:S,dataset:v}])}else T&&p(v,s,T,r)}else{var I=t.find(".btn-add-to-cart-fake");I&&I.hide().prop("disabled",!1).find(".throbbler").remove();var O=s.find(c.cartButtons);O&&O.removeClass("btn-inactive inactive").prop("disabled",!1).show()}"check"===v.target&&(n=v.modifiers)})).fail((function(){d(r,"-fail")}))}},m=function(e){var t=e.currentTarget;if(!$(t).parent().hasClass("active")&&!$(t).is("select")&&!$(t).hasClass("active-modifier")){var a=$(t).attr("data-price"),i=$(t).attr("data-label");$(t).parents(".modifier-group").find(".selected-value-price").addClass("temporary-value").text(a),$(t).parents(".modifier-group").find(".selected-value").text(i)}},h=function(e){var t=$(this);if(!$(t).parent().hasClass("active")&&!$(t).is("select")&&!$(t).hasClass("active-modifier")){var a=$(t).parents(".modifier-group").find(".selected-value-price"),i=$(t).parents(".modifier-group").find(".selected-value");$(a).removeClass("temporary-value").text($(a).attr("data-default-price")),$(i).text($(i).attr("data-default-value"))}},g=function(e){clearTimeout(s),s=setTimeout(function(){f.call(this,e)}.bind(this),300)},b=function(e){var a=$(this),i=t.find(".btn-add-to-cart-fake"),r=!0;$(".properties-selection-form select").each((function(){var e=$(this).val();(!e||e<1)&&(r=!1)})),r&&(a.hide(),i.show().prop("disabled",!0).prepend('<span class="throbbler"></span>'))},v=function(e){var a=t.find("[name=btn-add-to-cart]"),i=t.find(".btn-add-to-cart-fake"),r=i.html(),o=$(".cart-products-count").html(),s=JSON.parse($("#product-details-text-phrases").html());console.log(s.productsInCartSuffix),i.html('<i class="fa fa-check"></i> '+parseInt(o)+s.productsInCartSuffix).prop("disabled",!0).addClass("btn-buy-complete"),setTimeout((function(){i.html(r).removeClass("btn-buy-complete").hide().prop("disabled",!1),$(".throbbler",a).remove(),a.show()}),5e3)};return l.init=function(e){var a=t.find("form");"product-info"===c.page&&(a.find("[name=btn-add-to-cart]").on("touchstart touchmove touchend touchcancel",(function(){return a.find("[name=btn-add-to-cart]").click()})),a.find("[name=btn-add-to-cart]").on("mouseup",b),$("body").on("CART_DROPDOWN_OPEN",v)),a.on("submit",{target:"cart"},f).on("click",c.wishlistButtons,{target:"wishlist"},f).on("click",c.priceOfferButtons,{target:"price_offer"},f).on("change",c.attributes,{target:"check"},f).on("mouseover",c.attributes,m).on("mouseout",c.attributes,h).on("blur",c.productOptionField,{target:"check"},f).on("click",c.productOptions,{target:"check"},(function(e){!function(e){var t=e.currentTarget,a=$(t).attr("data-price"),i=$(t).attr("data-label");$(t).parents(".modifier-group").find(".selected-value-price").removeClass("temporary-value").attr("data-default-price",a),$(t).parents(".modifier-group").find(".selected-value").attr("data-default-value",i)}(e),function(e){var t=e.currentTarget,a=$(t).data("value"),i=$(t).parents(".modifier-group");$(i).find("li.active").removeClass("active"),$(i).find(".modifier-item.active-modifier").removeClass("active-modifier"),$(i).find("input.hidden-input").val(a),$(i).find("input.hidden-input").trigger("blur",[]),$(t).parents("li").addClass("active"),$(t).addClass("active-modifier")}(e)})).on("mouseover",c.productOptions,m).on("mouseout",c.productOptions,h).on("blur",c.quantity,{target:"check"},(function(e){f(e)})).on("keyup",c.quantity,{target:"check"},g),a.not(".no-status-check").not(".product-info").each((function(){f.call($(this))})),e()},l}));