"use strict";gambio.widgets.module("customizer",[jse.source+"/vendor/jquery-ui-dist/jquery-ui.min.js",gambio.source+"/libs/events"],(function(e){var t=$(this),r=$("body"),i=$(window),d=null,n=$.extend(!0,{},{requestUrl:"request_port.php?module=GPrint",uidSelector:"#gm_gprint_random",page:"product"},e),a={},o=$("[name=btn-add-to-cart]"),s=$(".btn-add-to-cart-fake"),u=s.html(),c=function(e,r){var i=jse.libs.form.getData(t,null,!0),d=$.extend({mode:"frontend",action:e.data.action},r.dataset,{},i),n=[],a=[],o=function(){var e=$(this).attr("name").replace(/(id|modifiers\[attribute\])\[(\d+)\]/,"$2");a.push("{"+e+"}"+$(this).val())};$('.customizer select[name^="id["], .customizer input[name^="id["]:checked').each(o),$('.customizer select[name^="modifiers[attribute]["], .customizer input[name^="modifiers[attribute]["]:checked').each(o),$('.customizer input[type=radio][name^="modifiers[attribute]["]:checked').each(o),$('.customizer input[type=hidden][name^="modifiers[attribute]["]').each(o);var s=(a=a.filter((function(e,t,r){return r.indexOf(e)===t}))).join("");d.products_id=d.products_id+s+"{"+e.data.random.match(/\d+/)+"}0",t.find('input[type="file"]').each((function(){if($(this).get(0).files.length>0){var e=$.Deferred();n.push(e),$(this).hide(),$(this).parent().append('<img src="gm/images/gprint/upload.gif" width="16" height="11" class="gm_gprint_loading" id="loading_'+$(this).attr("id")+'" />'),l($(this),d,e)}})),n.length?$.when.apply(void 0,n).done((function(){f(e,r,d)})).always((function(){})):f(e,r,d)},l=function(e,t,r){var i=e.get(0).files,d=n.requestUrl+"&action=upload&target="+t.target+"&mode=frontend&upload_field_id="+e.attr("id")+"&products_id="+t.products_id,a=[],c=function(){a.push($(this).val())};$('.customizer select[name^="properties_values_ids["]').each(c),$('.customizer select[name^="modifiers[property]["]').each(c),$('.customizer input[type=radio][name^="modifiers[property]["]:checked').each(c),$('.customizer input[type=hidden][name^="modifiers[property]["]').each(c),(a=a.filter((function(e,t,r){return r.indexOf(e)===t}))).forEach((function(e){d+="&properties_values_ids[]="+e})),e.fileupload({url:d,autoUpload:!1,replaceFileInput:!1,dataType:"json"}),e.fileupload("send",{files:i}).done((function(i){var d=e.attr("id"),n=e.val().replace(/C:\\fakepath\\/i,"");t[d]=n,e.parent().find("img").remove(),e.show(),s.html(u).removeClass("btn-buy-complete").hide().prop("disabled",!1),$(".throbbler",o).remove(),o.show(),i.ERROR?(alert(i.ERROR_MESSAGE),r.reject()):r.resolve(i)})).fail((function(t,i,d){e.parent().find("img").remove(),e.show(),r.reject()}))},f=function(e,t,r){d=d?d.abort():null,(d=jse.libs.xhr.post({url:n.requestUrl,data:r},!0)).done((function(){t.deferred&&t.deferred.resolve(e.data.random)})).fail((function(){t.deferred&&t.deferred.reject()}))},p=function(e,t){-1!==t.dataset.products_id[0].indexOf("}0")?(d=d?d.abort():null,(d=jse.libs.xhr.post({url:n.requestUrl,data:{action:"wishlist_to_cart",products_id:t.dataset.products_id[0],mode:"frontend"}},!0)).done((function(){t.deferred&&t.deferred.resolve()})).fail((function(){t.deferred&&t.deferred.reject()}))):t.deferred&&t.deferred.resolve()},m=function(e,t){if(-1!==t.dataset.products_id[0].indexOf("}0")){var r="update_wishlist";"cart"===n.page&&(r="update_cart"),d=d?d.abort():null,(d=jse.libs.xhr.post({url:n.requestUrl,data:{action:r,products_id:t.dataset.products_id[0],mode:"frontend"}},!0)).done((function(){t.deferred&&t.deferred.resolve()})).fail((function(){t.deferred&&t.deferred.reject()}))}else t.deferred&&t.deferred.resolve()};return a.init=function(e){if("product"===n.page){var t=$(n.uidSelector).attr("name");r.on(jse.libs.theme.events.ADD_CUSTOMIZER_CART(),{action:"add_cart",target:"cart",random:t},c),r.on(jse.libs.theme.events.ADD_CUSTOMIZER_WISHLIST(),{action:"add_wishlist",target:"wishlist",random:t},c)}r.on(jse.libs.theme.events.WISHLIST_TO_CART(),p),r.on(jse.libs.theme.events.WISHLIST_CART_DELETE(),m),$("#gm_gprint_tabs li").on("click",(function(){i.trigger(jse.libs.theme.events.STICKYBOX_CONTENT_CHANGE())})),i.trigger(jse.libs.theme.events.STICKYBOX_CONTENT_CHANGE());var d=[jse.source+"/vendor/blueimp-file-upload/jquery.fileupload.min.js"];window.require(d,e)},a}));