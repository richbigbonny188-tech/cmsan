"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};gambio.widgets.module("product_cart_handler",["form","xhr",gambio.source+"/libs/events",gambio.source+"/libs/modal.ext-magnific",gambio.source+"/libs/modal"],(function(e){var t=$(this),n=($(window),$("body")),i=null,a=null,o=null,r=null,s=null,l=null,c=null,d=null,u=!1,f=null,p={},h=!1,g=$.extend(!1,{},{ajax:!0,confirmDelete:!1,deleteInput:"#field_cart_delete_products_id",updateTarget:".shipping-calculation",checkUrl:"shop.php?do=CheckQuantity",updateUrl:"shop.php?do=Cart",changeClass:"has-changed",errorClass:"error",cartEmpty:".cart-empty",cartNotEmpty:".cart-not-empty",classLoading:"loading",actions:{add:"wishlist_to_cart",delete:"update_product",refresh:"update_wishlist"},ajaxActions:{add:"shop.php?do=WishList/AddToCart",delete:"shop.php?do=Cart/Delete",refresh:"shop.php?do=Cart/Update"},selectorMapping:{buttons:".shopping-cart-button",giftContent:".gift-cart-content-wrapper",giftLayer:".gift-cart-layer",shareContent:".share-cart-content-wrapper",shareLayer:".share-cart-layer",hiddenOptions:"#cart_quantity .hidden-options",message:".global-error-messages",infoMessage:".info-message",shippingInformation:"#shipping-information-layer",totals:"#cart_quantity .total-box",errorMsg:".error-msg",submit:".button-submit"}},e),m={},b=function(e){e.find('input[type="text"]').each((function(){var e=$(this),t=e.val();e.data("oldValue",t)}))},v=function(e){var t=e&&e.length?e:i,n=e&&e.length?e:i.find(".order-wishlist .item:gt(0)"),a=i.find('.hidden-options input[type="hidden"]'),o=jse.libs.form.getData(t),r=[],s=null;return $.each(o.products_id,(function(e,t){(s={}).target=n.eq(e),$.each(o,(function(t,n){"object"===(void 0===n?"undefined":_typeof(n))&&void 0!==n[e]&&(s[t]=[n[e]])})),a.filter('[name^="id['+t+'"], .force').each((function(){var e=$(this),t=e.attr("name");s[t]=e.val()})),r.push(s)})),r},y=function(e,t,n){var i=!1;return n=n||v(),$.each(n,(function(){var e=this.target.find("."+g.changeClass);return!(i=i||!!e.length)})),$.when.apply(void 0,[]).promise()},_=function(e,t){return delete p["product_"+e],t.removeClass("loading"),p},C=function(e,i,o){jse.libs.theme.helpers.fill(i.content,n,g.selectorMapping),$(".info-message").toggleClass("hidden",""===$(".info-message").text()),a.trigger(jse.libs.theme.events.CART_UPDATED(),[]),n.trigger(jse.libs.theme.events.CART_UPDATE(),"add"===o),b(e),$.isEmptyObject(i.products)?(s.addClass("hidden"),r.removeClass("hidden")):(r.addClass("hidden"),s.removeClass("hidden")),window.gambio.widgets.init(t)},j=function(e,t,n,a,o){if(g.ajax)delete n.target,e.trigger(jse.libs.theme.events.TRANSITION(),f),jse.libs.xhr.ajax({url:c,data:n},!0).done((function(e){jse.libs.hooks.execute(jse.libs.hooks.keys.shop.cart.change,{$target:t,dataset:n,article:a,type:o,result:e},500);var i,r=$(e.products["product_"+a]||"");r.removeClass(g.classLoading),t.replaceWith(r),i=e.content.errorMessageList,$.each(i,(function(e,t){var n={message:t},i=$('input[value^="'+e+'"]').closest("tr");jse.libs.theme.helpers.fill(n,i,g.selectorMapping),""!==i.find(".error-msg").text()&&i.find(".error-msg").show()})),delete e.content.errorMessageList,C(t,e,o);var s=a.match(/\d+/)[0];$('input[value^="'+s+'"]').parent("td").each((function(){if(!$(this).find('input[value="'+a+'"]').length){var n=$(this).find('input[id="products_id[]"]').attr("value");r=$(e.products["product_"+n]||""),(t=$(this).parent("tr")).replaceWith(r)}}))})).always((function(){_(a,e)}));else{var r=$.Deferred();r.always((function(){_(a,e)})),i.trigger("submit",r)}},T=function(){var e=$(this),t=e.val()!==e.data().oldValue;t?(h=t,e.addClass(g.changeClass)):e.removeClass(g.changeClass),L()},E=function(){var e=$(this);e.val()!==e.data().oldValue&&e.closest(".item").find(".button-refresh").first().trigger("click")},x=function(e){e.preventDefault(),e.stopPropagation();var t=$(this).closest(".item"),a=e.data.type,r=v(t)[0],s=r.products_id[0],d=r.target;d.find(".product-title").text();if(t.addClass("loading"),$.isEmptyObject(p)||g.ajax&&!p["product_"+s])switch(p["product_"+s]=!0,function(e){g.ajax?c=g.ajaxActions[e]:g.actions&&g.actions[e]&&(c=c.replace(/(action=)[^\&]+/,"$1"+g.actions[e]),i.attr("action",c))}(a),a){case"delete":if(o.val(s),r[l]=[s],g.confirmDelete){var u=jse.core.lang.translate("CART_WISHLIST_DELETE_TITLE","general"),f=jse.core.lang.translate("CART_WISHLIST_DELETE","general");jse.libs.theme.modal.confirm({content:f,title:u}).done((function(){var e=$.Deferred();e.done((function(){j(t,d,r,s,a)})),n.trigger(jse.libs.theme.events.WISHLIST_CART_DELETE(),[{deferred:e,dataset:r}])})).fail((function(){_(s,t)}))}else{var h=$.Deferred();h.done((function(){j(t,d,r,s,a)})),n.trigger(jse.libs.theme.events.WISHLIST_CART_DELETE(),[{deferred:h,dataset:r}])}break;default:y(0,0,[$.extend(!0,{},r)]).done((function(){o.val("");var e=null;if("add"===a&&(e=jse.libs.theme.events.WISHLIST_TO_CART()),e){var i=$.Deferred();i.done((function(){j(t,d,r,s,a)})),n.trigger(e,[{deferred:i,dataset:r}])}else j(t,d,r,s,a)})).fail((function(){_(s,t)}))}},k=function(e,t){if(e.preventDefault(),e.stopPropagation(),!t&&e.originalEvent){var n=$(e.originalEvent.explicitOriginalTarget);n.length&&n.is('input[type="text"]')&&n.closest(".item").find(".button-refresh").first().trigger("click")}else t&&y().done((function(){i.off("submit").trigger("submit"),"object"===(void 0===t?"undefined":_typeof(t))&&t.resolve()})).fail((function(){"object"===(void 0===t?"undefined":_typeof(t))&&t.reject()}))},w=function(e){if(e.preventDefault(),e.stopPropagation(),h){var t=v();return $.each(t,(function(){var e=this.target.find("."+g.changeClass);e&&e.closest(".item").find(".button-refresh").first().trigger("click")})),h=!1,void L()}var n=$(this).attr("href");!$.isEmptyObject(p)||d||u||(d=!0,y().done((function(){function t(){location.href=n}jse.libs.hooks.execute(jse.libs.hooks.keys.shop.cart.checkout,{event:e},500).then(t).catch(t)})).always((function(){d=!1})))},D=function(e,t){e.stopPropagation(),y((t=t||{}).showChanges,t.revertChanges).done((function(){t.deferred&&t.deferred.resolve()})).fail((function(){t.deferred&&t.deferred.reject()}))},L=function(){i.find(g.selectorMapping.submit).text(jse.core.lang.translate(h?"refresh":"checkout","buttons"))};return m.init=function(e){a=$(g.updateTarget),r=$(g.cartEmpty),s=$(g.cartNotEmpty),o=$(g.deleteInput),i=t.find("form").first(),l=o.attr("name"),c=i.attr("action"),f={open:!0,classOpen:g.classLoading},b(i),i.on("input",'input[type="text"]:not(.gift-coupon-code-input)',T).on("blur",'input[type="text"]:not(.gift-coupon-code-input)',E).on("click.delete",".button-delete",{type:"delete"},x).on("click.refresh",".button-refresh",{type:"refresh"},x).on("click.addtocart",".button-to-cart",{type:"add"},x).on("click.submit",".button-submit",{type:"submit"},w).on("submit",k).on(jse.libs.theme.events.CHECK_CART(),D),$('a.toggleusebalance input[name="gv_use_balance"]').on("click",(function(){console.info("click"),location=$(this).parent("a").get(0).href})),e()},m}));